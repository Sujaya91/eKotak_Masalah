<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>E-Kotak Curhat - Layanan BK</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        pastel: {
                            pink: '#FFD6E0',
                            purple: '#E8D5F2',
                            blue: '#D4E5FF',
                            mint: '#D5F5E3',
                            yellow: '#FFF5CC',
                            peach: '#FFE5D9',
                            lavender: '#E8E0F0',
                            cream: '#FFF8F0'
                        }
                    },
                    fontFamily: {
                        nunito: ['Nunito', 'sans-serif']
                    }
                }
            }
        }
    </script>
  <style>
        * { font-family: 'Nunito', sans-serif; }
        .sidebar-transition { transition: transform 0.3s ease-in-out; }
        .card-hover { transition: all 0.2s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .toast { animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s forwards; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes fadeOut { to { opacity: 0; } }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #a78bfa; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
        }
        .print-only { display: none; }
    </style>
  <style>body { box-sizing: border-box; }</style>
 </head>
 <body class="h-full bg-gradient-to-br from-pastel-cream via-pastel-lavender to-pastel-blue overflow-auto">
  <div id="app" class="h-full w-full">
   <!-- Login Page -->
   <div id="loginPage" class="min-h-full flex items-center justify-center p-4">
    <div class="w-full max-w-md">
     <div class="bg-white/90 backdrop-blur-sm rounded-3xl shadow-xl p-8 card-hover">
      <div class="text-center mb-8">
       <div class="w-20 h-20 bg-gradient-to-br from-pastel-purple to-pastel-pink rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
        <svg class="w-10 h-10 text-purple-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
        </svg>
       </div>
       <p class="text-sm text-gray-500 mb-2" id="loginInstansi">-</p>
       <h1 class="text-2xl font-bold text-gray-700">E-Kotak Curhat</h1>
       <p class="text-gray-500 mt-2">Layanan Bimbingan &amp; Konseling</p>
      </div>
      <div id="loginForm">
       <div class="space-y-4">
        <div>
         <label class="block text-sm font-medium text-gray-600 mb-2">Username</label> <input type="text" id="loginUsername" class="w-full px-4 py-3 rounded-xl bg-pastel-lavender/50 border-2 border-transparent focus:border-purple-400 focus:bg-white outline-none transition" placeholder="Masukkan username">
        </div>
        <div>
         <label class="block text-sm font-medium text-gray-600 mb-2">Password</label> <input type="password" id="loginPassword" class="w-full px-4 py-3 rounded-xl bg-pastel-lavender/50 border-2 border-transparent focus:border-purple-400 focus:bg-white outline-none transition" placeholder="Masukkan password">
        </div>
        <div id="loginError" class="hidden text-red-500 text-sm text-center bg-red-50 p-3 rounded-xl"></div><button onclick="handleLogin()" class="w-full py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold rounded-xl hover:opacity-90 transition shadow-lg"> Masuk </button>
       </div>
       <div class="mt-6 text-center">
        <p class="text-gray-500">Belum punya akun?</p><button onclick="showRegister()" class="text-purple-600 font-semibold hover:underline">Daftar sebagai Siswa</button>
       </div>
      </div>
      <div id="registerForm" class="hidden">
       <h2 class="text-xl font-bold text-gray-700 mb-4 text-center">Daftar Akun Siswa</h2>
       <div class="space-y-3">
        <div>
         <label class="block text-sm font-medium text-gray-600 mb-1">Nama Lengkap (Sesuai Daftar Hadir)</label> <input type="text" id="regNama" class="w-full px-4 py-2.5 rounded-xl bg-pastel-mint/50 border-2 border-transparent focus:border-green-400 focus:bg-white outline-none transition" placeholder="Nama lengkap">
        </div>
        <div class="grid grid-cols-2 gap-3">
         <div>
          <label class="block text-sm font-medium text-gray-600 mb-1">Kelas</label> <input type="text" id="regKelas" class="w-full px-4 py-2.5 rounded-xl bg-pastel-mint/50 border-2 border-transparent focus:border-green-400 focus:bg-white outline-none transition" placeholder="Contoh: X IPA 1">
         </div>
         <div>
          <label class="block text-sm font-medium text-gray-600 mb-1">No. Absen</label> <input type="text" id="regAbsen" class="w-full px-4 py-2.5 rounded-xl bg-pastel-mint/50 border-2 border-transparent focus:border-green-400 focus:bg-white outline-none transition" placeholder="Contoh: 15">
         </div>
        </div>
        <div>
         <label class="block text-sm font-medium text-gray-600 mb-1">Nomor WhatsApp</label> <input type="text" id="regWA" class="w-full px-4 py-2.5 rounded-xl bg-pastel-mint/50 border-2 border-transparent focus:border-green-400 focus:bg-white outline-none transition" placeholder="Contoh: 08123456789">
        </div>
        <div>
         <label class="block text-sm font-medium text-gray-600 mb-1">Username</label> <input type="text" id="regUsername" class="w-full px-4 py-2.5 rounded-xl bg-pastel-mint/50 border-2 border-transparent focus:border-green-400 focus:bg-white outline-none transition" placeholder="Buat username">
        </div>
        <div>
         <label class="block text-sm font-medium text-gray-600 mb-1">Password</label> <input type="password" id="regPassword" class="w-full px-4 py-2.5 rounded-xl bg-pastel-mint/50 border-2 border-transparent focus:border-green-400 focus:bg-white outline-none transition" placeholder="Buat password">
        </div>
        <div id="registerError" class="hidden text-red-500 text-sm text-center bg-red-50 p-3 rounded-xl"></div><button onclick="handleRegister()" id="registerBtn" class="w-full py-3 bg-gradient-to-r from-green-500 to-teal-500 text-white font-semibold rounded-xl hover:opacity-90 transition shadow-lg"> Daftar Sekarang </button>
       </div>
       <div class="mt-4 text-center">
        <button onclick="showLogin()" class="text-purple-600 font-semibold hover:underline">Kembali ke Login</button>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Dashboard Admin -->
   <div id="adminDashboard" class="hidden h-full">
    <div class="flex h-full">
     <!-- Sidebar -->
     <div id="adminSidebar" class="fixed lg:static inset-y-0 left-0 z-50 w-72 bg-white/95 backdrop-blur-sm shadow-xl sidebar-transition transform -translate-x-full lg:translate-x-0">
      <div class="flex flex-col h-full">
       <div class="p-6 bg-gradient-to-r from-purple-500 to-pink-500">
        <div class="flex items-center gap-3">
         <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
         </div>
         <div>
          <h2 class="text-white font-bold">Guru BK</h2>
          <p class="text-white/80 text-sm" id="adminNamaDisplay">Administrator</p>
         </div>
        </div>
       </div>
       <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
        <button onclick="showAdminMenu('beranda')" class="admin-menu-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-pastel-purple/50 transition" data-menu="beranda">
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
         </svg><span class="font-medium">Beranda</span> </button> <button onclick="showAdminMenu('template')" class="admin-menu-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-pastel-purple/50 transition" data-menu="template">
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
         </svg><span class="font-medium">Template Form</span> </button> <button onclick="showAdminMenu('dataSiswa')" class="admin-menu-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-pastel-purple/50 transition" data-menu="dataSiswa">
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
         </svg><span class="font-medium">Data Siswa</span> </button> <button onclick="showAdminMenu('daftarLaporan')" class="admin-menu-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-pastel-purple/50 transition" data-menu="daftarLaporan">
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
         </svg><span class="font-medium">Daftar Laporan</span> <span id="laporanBadge" class="hidden ml-auto bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">0</span> </button> <button onclick="showAdminMenu('pengaturan')" class="admin-menu-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-pastel-purple/50 transition" data-menu="pengaturan">
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
         </svg><span class="font-medium">Pengaturan</span> </button>
       </nav>
       <div class="p-4 border-t">
        <button onclick="handleLogout()" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-red-100 text-red-600 rounded-xl hover:bg-red-200 transition">
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
         </svg><span class="font-medium">Keluar</span> </button>
       </div>
      </div>
     </div><!-- Overlay for mobile -->
     <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden" onclick="toggleSidebar('admin')"></div><!-- Main Content -->
     <div class="flex-1 flex flex-col min-h-full overflow-auto">
      <!-- Header -->
      <header class="bg-white/80 backdrop-blur-sm shadow-sm sticky top-0 z-30">
       <div class="flex items-center justify-between px-4 py-3">
        <button onclick="toggleSidebar('admin')" class="lg:hidden p-2 rounded-lg hover:bg-gray-100">
         <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
         </svg></button>
        <h1 class="text-lg font-bold text-gray-700" id="adminPageTitle">Beranda</h1>
        <div class="w-10"></div>
       </div>
      </header><!-- Content Area -->
      <main class="flex-1 p-4 md:p-6">
       <!-- Beranda Admin -->
       <div id="adminBeranda" class="admin-content space-y-6">
        <div class="grid md:grid-cols-3 gap-4">
         <div class="bg-gradient-to-br from-pastel-purple to-pastel-pink p-6 rounded-2xl shadow-lg card-hover">
          <div class="flex items-center gap-4">
           <div class="w-14 h-14 bg-white/30 rounded-xl flex items-center justify-center">
            <svg class="w-7 h-7 text-purple-700" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
            </svg>
           </div>
           <div>
            <p class="text-purple-800/70 text-sm">Total Siswa</p>
            <p class="text-3xl font-bold text-purple-800" id="statSiswa">0</p>
           </div>
          </div>
         </div>
         <div class="bg-gradient-to-br from-pastel-blue to-pastel-mint p-6 rounded-2xl shadow-lg card-hover">
          <div class="flex items-center gap-4">
           <div class="w-14 h-14 bg-white/30 rounded-xl flex items-center justify-center">
            <svg class="w-7 h-7 text-blue-700" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
           </div>
           <div>
            <p class="text-blue-800/70 text-sm">Total Laporan</p>
            <p class="text-3xl font-bold text-blue-800" id="statLaporan">0</p>
           </div>
          </div>
         </div>
         <div class="bg-gradient-to-br from-pastel-yellow to-pastel-peach p-6 rounded-2xl shadow-lg card-hover">
          <div class="flex items-center gap-4">
           <div class="w-14 h-14 bg-white/30 rounded-xl flex items-center justify-center">
            <svg class="w-7 h-7 text-orange-700" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
           </div>
           <div>
            <p class="text-orange-800/70 text-sm">Sudah Ditangani</p>
            <p class="text-3xl font-bold text-orange-800" id="statDitangani">0</p>
           </div>
          </div>
         </div>
        </div>
        <div class="bg-white/90 rounded-2xl shadow-lg p-6">
         <h3 class="text-lg font-bold text-gray-700 mb-4 flex items-center gap-2">
          <svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg> Tentang E-Kotak Curhat</h3>
         <div class="prose prose-sm text-gray-600">
          <p><strong>E-Kotak Curhat</strong> adalah aplikasi berbasis web untuk menampung laporan dan curahan hati siswa kepada Guru BK secara digital dan rahasia. Aplikasi ini dirancang untuk:</p>
          <ul class="list-disc pl-5 mt-2 space-y-1">
           <li>Memudahkan siswa menyampaikan masalah tanpa rasa malu</li>
           <li>Menjaga kerahasiaan identitas dan isi laporan</li>
           <li>Membantu Guru BK memantau dan menangani kasus dengan lebih efektif</li>
           <li>Menciptakan lingkungan sekolah yang lebih kondusif</li>
          </ul>
         </div>
        </div>
        <div class="grid md:grid-cols-2 gap-6">
         <div class="bg-white/90 rounded-2xl shadow-lg p-6">
          <h3 class="text-lg font-bold text-gray-700 mb-4 flex items-center gap-2">
           <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
           </svg> 5 Laporan Terakhir</h3>
          <div id="recentReports" class="space-y-3">
           <p class="text-gray-500 text-sm text-center py-4">Belum ada laporan</p>
          </div>
         </div>
         <div class="bg-white/90 rounded-2xl shadow-lg p-6">
          <h3 class="text-lg font-bold text-gray-700 mb-4 flex items-center gap-2">
           <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
           </svg> 3 Aktivitas Terakhir</h3>
          <div id="recentActivities" class="space-y-3">
           <p class="text-gray-500 text-sm text-center py-4">Belum ada aktivitas</p>
          </div>
         </div>
        </div>
       </div><!-- Template Form -->
       <div id="adminTemplate" class="admin-content hidden space-y-6">
        <div class="bg-white/90 rounded-2xl shadow-lg p-6">
         <h3 class="text-lg font-bold text-gray-700 mb-4">Template Form Laporan Kasus</h3>
         <p class="text-gray-500 text-sm mb-4">Atur field-field yang akan diisi oleh siswa saat membuat laporan.</p>
         <div id="templateFields" class="space-y-3 mb-4">
          <!-- Dynamic fields will be added here -->
         </div>
         <div class="flex gap-3">
          <button onclick="addTemplateField()" class="px-4 py-2 bg-pastel-purple text-purple-700 font-medium rounded-xl hover:bg-purple-200 transition flex items-center gap-2">
           <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
           </svg> Tambah Field </button> <button onclick="saveTemplate()" id="saveTemplateBtn" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-medium rounded-xl hover:opacity-90 transition"> Simpan Template </button>
         </div>
        </div>
        <div class="bg-white/90 rounded-2xl shadow-lg p-6">
         <h3 class="text-lg font-bold text-gray-700 mb-4">Preview Form</h3>
         <div id="templatePreview" class="bg-pastel-cream rounded-xl p-4">
          <p class="text-gray-500 text-sm text-center">Tambahkan field untuk melihat preview</p>
         </div>
        </div>
       </div><!-- Data Siswa -->
       <div id="adminDataSiswa" class="admin-content hidden">
        <div class="bg-white/90 rounded-2xl shadow-lg p-6">
         <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
          <h3 class="text-lg font-bold text-gray-700">Data Siswa Terdaftar</h3>
          <div class="relative">
           <input type="text" id="searchSiswa" onkeyup="filterSiswa()" placeholder="Cari siswa..." class="pl-10 pr-4 py-2 rounded-xl bg-pastel-lavender/50 border-2 border-transparent focus:border-purple-400 focus:bg-white outline-none transition w-full md:w-64">
           <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
           </svg>
          </div>
         </div>
         <div class="overflow-x-auto">
          <table class="w-full text-sm">
           <thead>
            <tr class="bg-pastel-purple/50">
             <th class="px-4 py-3 text-left font-semibold text-gray-700 rounded-tl-xl">No</th>
             <th class="px-4 py-3 text-left font-semibold text-gray-700">Nama Siswa</th>
             <th class="px-4 py-3 text-left font-semibold text-gray-700">Kelas</th>
             <th class="px-4 py-3 text-left font-semibold text-gray-700">No. Absen</th>
             <th class="px-4 py-3 text-left font-semibold text-gray-700">No. WhatsApp</th>
             <th class="px-4 py-3 text-left font-semibold text-gray-700">Username</th>
             <th class="px-4 py-3 text-left font-semibold text-gray-700 rounded-tr-xl">Aksi</th>
            </tr>
           </thead>
           <tbody id="siswaTableBody">
            <tr>
             <td colspan="7" class="px-4 py-8 text-center text-gray-500">Belum ada siswa terdaftar</td>
            </tr>
           </tbody>
          </table>
         </div>
        </div>
       </div><!-- Daftar Laporan -->
       <div id="adminDaftarLaporan" class="admin-content hidden">
        <div class="bg-white/90 rounded-2xl shadow-lg p-6">
         <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
          <h3 class="text-lg font-bold text-gray-700">Daftar Laporan Masuk</h3>
          <div class="flex flex-col md:flex-row gap-3">
           <select id="filterStatus" onchange="filterLaporan()" class="px-4 py-2 rounded-xl bg-pastel-lavender/50 border-2 border-transparent focus:border-purple-400 outline-none"> <option value="">Semua Status</option> <option value="Menunggu">Menunggu</option> <option value="Ditangani">Sudah Ditangani</option> </select>
           <div class="relative">
            <input type="text" id="searchLaporan" onkeyup="filterLaporan()" placeholder="Cari laporan..." class="pl-10 pr-4 py-2 rounded-xl bg-pastel-lavender/50 border-2 border-transparent focus:border-purple-400 focus:bg-white outline-none transition w-full">
            <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
           </div>
          </div>
         </div>
         <div class="overflow-x-auto">
          <table class="w-full text-sm">
           <thead>
            <tr class="bg-pastel-blue/50">
             <th class="px-4 py-3 text-left font-semibold text-gray-700 rounded-tl-xl">No</th>
             <th class="px-4 py-3 text-left font-semibold text-gray-700">Tanggal</th>
             <th class="px-4 py-3 text-left font-semibold text-gray-700">Nama Siswa</th>
             <th class="px-4 py-3 text-left font-semibold text-gray-700">Kelas</th>
             <th class="px-4 py-3 text-left font-semibold text-gray-700">Kategori</th>
             <th class="px-4 py-3 text-left font-semibold text-gray-700">Status</th>
             <th class="px-4 py-3 text-left font-semibold text-gray-700 rounded-tr-xl">Aksi</th>
            </tr>
           </thead>
           <tbody id="laporanTableBody">
            <tr>
             <td colspan="7" class="px-4 py-8 text-center text-gray-500">Belum ada laporan masuk</td>
            </tr>
           </tbody>
          </table>
         </div>
        </div>
       </div><!-- Pengaturan -->
       <div id="adminPengaturan" class="admin-content hidden space-y-6">
        <div class="bg-white/90 rounded-2xl shadow-lg p-6">
         <h3 class="text-lg font-bold text-gray-700 mb-4">Pengaturan Instansi</h3>
         <div class="space-y-4">
          <div>
           <label class="block text-sm font-medium text-gray-600 mb-2">Nama Instansi/Sekolah</label> <input type="text" id="setNamaInstansi" class="w-full px-4 py-3 rounded-xl bg-pastel-lavender/50 border-2 border-transparent focus:border-purple-400 focus:bg-white outline-none transition" placeholder="Contoh: SMA Negeri 1 Contoh">
          </div>
          <div class="grid md:grid-cols-2 gap-4">
           <div>
            <label class="block text-sm font-medium text-gray-600 mb-2">Nama Guru BK</label> <input type="text" id="setNamaGuru" class="w-full px-4 py-3 rounded-xl bg-pastel-lavender/50 border-2 border-transparent focus:border-purple-400 focus:bg-white outline-none transition" placeholder="Nama lengkap guru BK">
           </div>
           <div>
            <label class="block text-sm font-medium text-gray-600 mb-2">NIP Guru BK</label> <input type="text" id="setNipGuru" class="w-full px-4 py-3 rounded-xl bg-pastel-lavender/50 border-2 border-transparent focus:border-purple-400 focus:bg-white outline-none transition" placeholder="NIP guru BK">
           </div>
          </div><button onclick="saveSettings()" id="saveSettingsBtn" class="px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold rounded-xl hover:opacity-90 transition"> Simpan Pengaturan </button>
         </div>
        </div>
        <div class="bg-white/90 rounded-2xl shadow-lg p-6">
         <h3 class="text-lg font-bold text-gray-700 mb-4">Panduan Sinkronisasi ke Google Sheets</h3>
         <div class="bg-pastel-yellow/50 rounded-xl p-4 mb-4">
          <p class="text-sm text-gray-700"><strong>Langkah-langkah:</strong></p>
          <ol class="list-decimal pl-5 mt-2 space-y-2 text-sm text-gray-600">
           <li>Buka Google Sheets dan buat spreadsheet baru</li>
           <li>Klik menu <strong>Extensions</strong> ‚Üí <strong>Apps Script</strong></li>
           <li>Hapus kode default dan paste kode di bawah ini</li>
           <li>Simpan dan deploy sebagai Web App</li>
           <li>Copy URL Web App dan gunakan untuk integrasi</li>
          </ol>
         </div>
         <div class="bg-gray-900 rounded-xl p-4 overflow-x-auto">
          <pre class="text-green-400 text-xs"><code>// Google Apps Script untuk E-Kotak Curhat
// Deploy sebagai Web App dengan akses "Anyone"

const SHEET_NAME_SISWA = 'Data Siswa';
const SHEET_NAME_LAPORAN = 'Data Laporan';

function doGet(e) {
  return handleRequest(e);
}

function doPost(e) {
  return handleRequest(e);
}

function handleRequest(e) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const action = e.parameter.action;
  
  let result = { success: false, message: 'Unknown action' };
  
  try {
    if (action === 'addSiswa') {
      result = addSiswa(ss, e.parameter);
    } else if (action === 'addLaporan') {
      result = addLaporan(ss, e.parameter);
    } else if (action === 'getSiswa') {
      result = getSiswa(ss);
    } else if (action === 'getLaporan') {
      result = getLaporan(ss);
    } else if (action === 'updateStatus') {
      result = updateStatus(ss, e.parameter);
    }
  } catch (error) {
    result = { success: false, message: error.toString() };
  }
  
  return ContentService
    .createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}

function getOrCreateSheet(ss, name, headers) {
  let sheet = ss.getSheetByName(name);
  if (!sheet) {
    sheet = ss.insertSheet(name);
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    sheet.getRange(1, 1, 1, headers.length)
      .setBackground('#E8D5F2')
      .setFontWeight('bold');
  }
  return sheet;
}

function addSiswa(ss, params) {
  const headers = ['ID', 'Nama Lengkap', 'Kelas', 'No Absen', 'No WA', 'Username', 'Tanggal Daftar'];
  const sheet = getOrCreateSheet(ss, SHEET_NAME_SISWA, headers);
  
  const id = Utilities.getUuid();
  const row = [
    id,
    params.nama,
    params.kelas,
    params.absen,
    params.wa,
    params.username,
    new Date().toLocaleString('id-ID')
  ];
  
  sheet.appendRow(row);
  return { success: true, message: 'Siswa berhasil ditambahkan', id: id };
}

function addLaporan(ss, params) {
  const headers = ['ID', 'Tanggal', 'Nama Siswa', 'Kelas', 'Kategori', 'Isi Laporan', 'Status', 'Catatan Guru'];
  const sheet = getOrCreateSheet(ss, SHEET_NAME_LAPORAN, headers);
  
  const id = Utilities.getUuid();
  const row = [
    id,
    new Date().toLocaleString('id-ID'),
    params.nama,
    params.kelas,
    params.kategori,
    params.isi,
    'Menunggu',
    ''
  ];
  
  sheet.appendRow(row);
  return { success: true, message: 'Laporan berhasil dikirim', id: id };
}

function getSiswa(ss) {
  const sheet = ss.getSheetByName(SHEET_NAME_SISWA);
  if (!sheet) return { success: true, data: [] };
  
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  const result = data.slice(1).map(row =&gt; {
    const obj = {};
    headers.forEach((h, i) =&gt; obj[h] = row[i]);
    return obj;
  });
  
  return { success: true, data: result };
}

function getLaporan(ss) {
  const sheet = ss.getSheetByName(SHEET_NAME_LAPORAN);
  if (!sheet) return { success: true, data: [] };
  
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  const result = data.slice(1).map(row =&gt; {
    const obj = {};
    headers.forEach((h, i) =&gt; obj[h] = row[i]);
    return obj;
  });
  
  return { success: true, data: result };
}

function updateStatus(ss, params) {
  const sheet = ss.getSheetByName(SHEET_NAME_LAPORAN);
  if (!sheet) return { success: false, message: 'Sheet tidak ditemukan' };
  
  const data = sheet.getDataRange().getValues();
  for (let i = 1; i &lt; data.length; i++) {
    if (data[i][0] === params.id) {
      sheet.getRange(i + 1, 7).setValue(params.status);
      if (params.catatan) {
        sheet.getRange(i + 1, 8).setValue(params.catatan);
      }
      return { success: true, message: 'Status berhasil diupdate' };
    }
  }
  
  return { success: false, message: 'Laporan tidak ditemukan' };
}</code></pre>
         </div><button onclick="copyAppsScript()" class="mt-4 px-4 py-2 bg-pastel-mint text-green-700 font-medium rounded-xl hover:bg-green-200 transition flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
          </svg> Salin Kode Apps Script </button>
        </div>
       </div>
      </main>
     </div>
    </div>
   </div><!-- Dashboard Siswa -->
   <div id="siswaDashboard" class="hidden h-full">
    <div class="flex h-full">
     <!-- Sidebar Siswa -->
     <div id="siswaSidebar" class="fixed lg:static inset-y-0 left-0 z-50 w-72 bg-white/95 backdrop-blur-sm shadow-xl sidebar-transition transform -translate-x-full lg:translate-x-0">
      <div class="flex flex-col h-full">
       <div class="p-6 bg-gradient-to-r from-teal-500 to-cyan-500">
        <div class="flex items-center gap-3">
         <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
         </div>
         <div>
          <h2 class="text-white font-bold truncate" id="siswaNameDisplay">Siswa</h2>
          <p class="text-white/80 text-sm" id="siswaKelasDisplay">Kelas</p>
         </div>
        </div>
       </div>
       <nav class="flex-1 p-4 space-y-2">
        <button onclick="showSiswaMenu('beranda')" class="siswa-menu-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-pastel-mint/50 transition" data-menu="beranda">
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
         </svg><span class="font-medium">Beranda</span> </button> <button onclick="showSiswaMenu('inputLaporan')" class="siswa-menu-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-pastel-mint/50 transition" data-menu="inputLaporan">
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
         </svg><span class="font-medium">Input Laporan</span> </button> <button onclick="showSiswaMenu('catatanGuru')" class="siswa-menu-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-pastel-mint/50 transition" data-menu="catatanGuru">
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
         </svg><span class="font-medium">Catatan Guru BK</span> <span id="catatanBadge" class="hidden ml-auto bg-teal-500 text-white text-xs px-2 py-0.5 rounded-full">0</span> </button>
       </nav>
       <div class="p-4 border-t">
        <button onclick="handleLogout()" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-red-100 text-red-600 rounded-xl hover:bg-red-200 transition">
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
         </svg><span class="font-medium">Keluar</span> </button>
       </div>
      </div>
     </div><!-- Overlay for mobile siswa -->
     <div id="siswaSidebarOverlay" class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden" onclick="toggleSidebar('siswa')"></div><!-- Main Content Siswa -->
     <div class="flex-1 flex flex-col min-h-full overflow-auto">
      <!-- Header -->
      <header class="bg-white/80 backdrop-blur-sm shadow-sm sticky top-0 z-30">
       <div class="flex items-center justify-between px-4 py-3">
        <button onclick="toggleSidebar('siswa')" class="lg:hidden p-2 rounded-lg hover:bg-gray-100">
         <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
         </svg></button>
        <h1 class="text-lg font-bold text-gray-700" id="siswaPageTitle">Beranda</h1>
        <div class="w-10"></div>
       </div>
      </header><!-- Content Area Siswa -->
      <main class="flex-1 p-4 md:p-6">
       <!-- Beranda Siswa -->
       <div id="siswaBeranda" class="siswa-content space-y-6">
        <div class="bg-gradient-to-br from-pastel-mint to-pastel-blue p-6 rounded-2xl shadow-lg">
         <h2 class="text-xl font-bold text-gray-700 mb-2">Selamat Datang di E-Kotak Curhat! üíö</h2>
         <p class="text-gray-600">Tempat aman untuk berbagi cerita dan masalahmu.</p>
        </div>
        <div class="grid md:grid-cols-2 gap-6">
         <div class="bg-white/90 rounded-2xl shadow-lg p-6 card-hover">
          <div class="flex items-start gap-4">
           <div class="w-12 h-12 bg-pastel-purple rounded-xl flex items-center justify-center flex-shrink-0">
            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
           </div>
           <div>
            <h3 class="font-bold text-gray-700 mb-2">Apa itu Layanan BK?</h3>
            <p class="text-sm text-gray-600">Bimbingan dan Konseling adalah layanan bantuan untuk siswa dalam menghadapi berbagai permasalahan, baik akademik maupun non-akademik. Guru BK siap membantu kamu!</p>
           </div>
          </div>
         </div>
         <div class="bg-white/90 rounded-2xl shadow-lg p-6 card-hover">
          <div class="flex items-start gap-4">
           <div class="w-12 h-12 bg-pastel-pink rounded-xl flex items-center justify-center flex-shrink-0">
            <svg class="w-6 h-6 text-pink-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
            </svg>
           </div>
           <div>
            <h3 class="font-bold text-gray-700 mb-2">Tentang E-Kotak Curhat</h3>
            <p class="text-sm text-gray-600">E-Kotak Curhat adalah wadah digital untuk kamu menyampaikan curahan hati, masalah, atau laporan secara rahasia kepada Guru BK.</p>
           </div>
          </div>
         </div>
        </div>
        <div class="bg-white/90 rounded-2xl shadow-lg p-6">
         <h3 class="text-lg font-bold text-gray-700 mb-4 flex items-center gap-2">
          <svg class="w-5 h-5 text-teal-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
          </svg> Jaminan Kerahasiaan</h3>
         <div class="bg-pastel-mint/50 rounded-xl p-4">
          <ul class="space-y-2 text-sm text-gray-600">
           <li class="flex items-start gap-2">
            <svg class="w-5 h-5 text-green-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg><span>Identitasmu hanya diketahui oleh Guru BK</span></li>
           <li class="flex items-start gap-2">
            <svg class="w-5 h-5 text-green-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg><span>Laporanmu tidak akan disebarluaskan kepada pihak lain</span></li>
           <li class="flex items-start gap-2">
            <svg class="w-5 h-5 text-green-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg><span>Guru BK terikat kode etik untuk menjaga kerahasiaan</span></li>
           <li class="flex items-start gap-2">
            <svg class="w-5 h-5 text-green-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg><span>Kamu aman untuk bercerita tanpa takut dihakimi</span></li>
          </ul>
         </div>
        </div>
        <div class="bg-gradient-to-br from-pastel-yellow to-pastel-peach p-6 rounded-2xl shadow-lg">
         <h3 class="text-lg font-bold text-gray-700 mb-3">Maksud &amp; Tujuan</h3>
         <div class="grid md:grid-cols-3 gap-4">
          <div class="bg-white/50 rounded-xl p-4 text-center">
           <div class="text-3xl mb-2">
            üéØ
           </div>
           <p class="text-sm text-gray-600">Memfasilitasi siswa menyampaikan masalah</p>
          </div>
          <div class="bg-white/50 rounded-xl p-4 text-center">
           <div class="text-3xl mb-2">
            ü§ù
           </div>
           <p class="text-sm text-gray-600">Membangun komunikasi siswa-guru BK</p>
          </div>
          <div class="bg-white/50 rounded-xl p-4 text-center">
           <div class="text-3xl mb-2">
            üí™
           </div>
           <p class="text-sm text-gray-600">Mendukung kesejahteraan mental siswa</p>
          </div>
         </div>
        </div>
       </div><!-- Input Laporan Siswa -->
       <div id="siswaInputLaporan" class="siswa-content hidden">
        <div class="max-w-2xl mx-auto">
         <div class="bg-white/90 rounded-2xl shadow-lg p-6">
          <h3 class="text-lg font-bold text-gray-700 mb-2">Form Laporan</h3>
          <p class="text-gray-500 text-sm mb-6">Silakan isi form berikut dengan jujur. Laporanmu akan dijaga kerahasiaannya.</p>
          <div id="siswaFormContainer" class="space-y-4">
           <p class="text-gray-500 text-center py-8">Form belum tersedia. Hubungi Guru BK untuk mengaktifkan form laporan.</p>
          </div>
         </div>
        </div>
       </div><!-- Catatan Guru BK -->
       <div id="siswaCatatanGuru" class="siswa-content hidden">
        <div class="bg-white/90 rounded-2xl shadow-lg p-6">
         <h3 class="text-lg font-bold text-gray-700 mb-4">Catatan dari Guru BK</h3>
         <p class="text-gray-500 text-sm mb-4">Berikut adalah tanggapan dan catatan dari Guru BK untuk laporan yang telah kamu kirim.</p>
         <div id="catatanContainer" class="space-y-4">
          <p class="text-gray-500 text-center py-8">Belum ada catatan dari Guru BK</p>
         </div>
        </div>
       </div>
      </main>
     </div>
    </div>
   </div><!-- Modal Detail Laporan -->
   <div id="modalDetail" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50" onclick="closeModal()"></div>
    <div class="absolute inset-4 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-2xl bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col max-h-full md:max-h-[90vh]">
     <div class="p-4 bg-gradient-to-r from-purple-500 to-pink-500 flex items-center justify-between">
      <h3 class="text-white font-bold">Detail Laporan</h3><button onclick="closeModal()" class="text-white/80 hover:text-white">
       <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
       </svg></button>
     </div>
     <div id="modalContent" class="p-6 overflow-y-auto flex-1">
      <!-- Dynamic content -->
     </div>
     <div class="p-4 border-t flex flex-wrap gap-3 justify-end">
      <button onclick="printLaporan()" class="px-4 py-2 bg-pastel-blue text-blue-700 font-medium rounded-xl hover:bg-blue-200 transition flex items-center gap-2">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
       </svg> Cetak </button> <button onclick="markAsHandled()" id="btnHandled" class="px-4 py-2 bg-pastel-mint text-green-700 font-medium rounded-xl hover:bg-green-200 transition flex items-center gap-2">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
       </svg> Tandai Ditangani </button> <button onclick="showCatatanForm()" class="px-4 py-2 bg-pastel-yellow text-yellow-700 font-medium rounded-xl hover:bg-yellow-200 transition flex items-center gap-2">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
       </svg> Beri Catatan </button>
     </div>
    </div>
   </div><!-- Print Template (Hidden) -->
   <div id="printTemplate" class="print-only fixed inset-0 bg-white p-8">
    <div id="printContent"></div>
   </div><!-- Toast Container -->
   <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>
  </div>
  <script>
        // ==================== APP STATE ====================
        let appData = {
            siswa: [],
            laporan: [],
            settings: {
                nama_instansi: '',
                nama_guru: '',
                nip_guru: ''
            },
            template: {
                fields: [
                    { id: 'kategori', label: 'Kategori Masalah', type: 'select', options: ['Pribadi', 'Sosial', 'Belajar', 'Karir', 'Bullying', 'Lainnya'], required: true },
                    { id: 'isi_laporan', label: 'Isi Laporan/Curhat', type: 'textarea', placeholder: 'Ceritakan masalahmu di sini...', required: true }
                ]
            },
            activities: []
        };
        
        let currentUser = null;
        let currentLaporan = null;
        
        const defaultConfig = {
            app_title: 'E-Kotak Curhat',
            welcome_text: 'Selamat Datang di E-Kotak Curhat',
            primary_color: '#A78BFA',
            secondary_color: '#F0ABFC',
            accent_color: '#5EEAD4',
            text_color: '#374151',
            background_color: '#FFF8F0'
        };
        
        // ==================== SDK INITIALIZATION ====================
        const dataHandler = {
            onDataChanged(data) {
                appData.siswa = data.filter(d => d.type === 'siswa');
                appData.laporan = data.filter(d => d.type === 'laporan');
                
                const settingsData = data.find(d => d.type === 'settings');
                if (settingsData) {
                    appData.settings = {
                        nama_instansi: settingsData.nama_instansi || '',
                        nama_guru: settingsData.nama_guru || '',
                        nip_guru: settingsData.nip_guru || ''
                    };
                    document.getElementById('setNamaInstansi').value = appData.settings.nama_instansi;
                    document.getElementById('setNamaGuru').value = appData.settings.nama_guru;
                    document.getElementById('setNipGuru').value = appData.settings.nip_guru;
                    document.getElementById('adminNamaDisplay').textContent = appData.settings.nama_guru || 'Administrator';
                    updateInstansiDisplay();
                }
                
                const templateData = data.find(d => d.type === 'template');
                if (templateData && templateData.fields_json) {
                    try {
                        appData.template.fields = JSON.parse(templateData.fields_json);
                    } catch (e) {
                        console.error('Error parsing template:', e);
                    }
                }
                
                updateUI();
            }
        };
        
        async function initApp() {
            if (window.dataSdk) {
                const result = await window.dataSdk.init(dataHandler);
                if (!result.isOk) {
                    console.error('Failed to init data SDK');
                }
            }
            
            if (window.elementSdk) {
                window.elementSdk.init({
                    defaultConfig,
                    onConfigChange: async (config) => {
                        document.body.style.setProperty('--primary-color', config.primary_color || defaultConfig.primary_color);
                    },
                    mapToCapabilities: (config) => ({
                        recolorables: [
                            {
                                get: () => config.primary_color || defaultConfig.primary_color,
                                set: (v) => window.elementSdk.setConfig({ primary_color: v })
                            }
                        ],
                        borderables: [],
                        fontEditable: undefined,
                        fontSizeable: undefined
                    }),
                    mapToEditPanelValues: (config) => new Map([
                        ['app_title', config.app_title || defaultConfig.app_title],
                        ['welcome_text', config.welcome_text || defaultConfig.welcome_text]
                    ])
                });
            }
            
            renderTemplateFields();
            updateInstansiDisplay();
        }
        
        initApp();
        
        // ==================== AUTH FUNCTIONS ====================
        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
        }
        
        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }
        
        async function handleLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const errorEl = document.getElementById('loginError');
            
            if (!username || !password) {
                errorEl.textContent = 'Username dan password harus diisi!';
                errorEl.classList.remove('hidden');
                return;
            }
            
            // Admin login
            if (username === 'admin' && password === 'admin') {
                currentUser = { role: 'admin', username: 'admin' };
                errorEl.classList.add('hidden');
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('adminDashboard').classList.remove('hidden');
                showAdminMenu('beranda');
                addActivity('Admin login ke sistem');
                return;
            }
            
            // Student login
            const siswa = appData.siswa.find(s => s.username === username && s.password === password);
            if (siswa) {
                currentUser = { role: 'siswa', ...siswa };
                errorEl.classList.add('hidden');
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('siswaDashboard').classList.remove('hidden');
                document.getElementById('siswaNameDisplay').textContent = siswa.nama_lengkap;
                document.getElementById('siswaKelasDisplay').textContent = siswa.kelas;
                showSiswaMenu('beranda');
                renderSiswaForm();
                renderCatatanSiswa();
                return;
            }
            
            errorEl.textContent = 'Username atau password salah!';
            errorEl.classList.remove('hidden');
        }
        
        async function handleRegister() {
            const nama = document.getElementById('regNama').value.trim();
            const kelas = document.getElementById('regKelas').value.trim();
            const absen = document.getElementById('regAbsen').value.trim();
            const wa = document.getElementById('regWA').value.trim();
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value.trim();
            const errorEl = document.getElementById('registerError');
            const btn = document.getElementById('registerBtn');
            
            if (!nama || !kelas || !absen || !wa || !username || !password) {
                errorEl.textContent = 'Semua field harus diisi!';
                errorEl.classList.remove('hidden');
                return;
            }
            
            if (appData.siswa.find(s => s.username === username)) {
                errorEl.textContent = 'Username sudah digunakan!';
                errorEl.classList.remove('hidden');
                return;
            }
            
            if (appData.siswa.length >= 999) {
                errorEl.textContent = 'Batas maksimum pendaftaran tercapai!';
                errorEl.classList.remove('hidden');
                return;
            }
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Mendaftar...';
            
            if (window.dataSdk) {
                const result = await window.dataSdk.create({
                    type: 'siswa',
                    nama_lengkap: nama,
                    kelas: kelas,
                    nomor_absen: absen,
                    nomor_wa: wa,
                    username: username,
                    password: password,
                    created_at: new Date().toISOString()
                });
                
                if (result.isOk) {
                    showToast('Pendaftaran berhasil! Silakan login.', 'success');
                    showLogin();
                    // Clear form
                    document.getElementById('regNama').value = '';
                    document.getElementById('regKelas').value = '';
                    document.getElementById('regAbsen').value = '';
                    document.getElementById('regWA').value = '';
                    document.getElementById('regUsername').value = '';
                    document.getElementById('regPassword').value = '';
                    errorEl.classList.add('hidden');
                } else {
                    errorEl.textContent = 'Gagal mendaftar. Coba lagi.';
                    errorEl.classList.remove('hidden');
                }
            }
            
            btn.disabled = false;
            btn.textContent = 'Daftar Sekarang';
        }
        
        function handleLogout() {
            currentUser = null;
            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('siswaDashboard').classList.add('hidden');
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').classList.add('hidden');
        }
        
        // ==================== NAVIGATION ====================
        function toggleSidebar(type) {
            const sidebar = document.getElementById(type === 'admin' ? 'adminSidebar' : 'siswaSidebar');
            const overlay = document.getElementById(type === 'admin' ? 'sidebarOverlay' : 'siswaSidebarOverlay');
            
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }
        
        function showAdminMenu(menu) {
            document.querySelectorAll('.admin-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.admin-menu-btn').forEach(btn => {
                btn.classList.remove('bg-pastel-purple', 'text-purple-700');
            });
            
            const menuMap = {
                'beranda': 'adminBeranda',
                'template': 'adminTemplate',
                'dataSiswa': 'adminDataSiswa',
                'daftarLaporan': 'adminDaftarLaporan',
                'pengaturan': 'adminPengaturan'
            };
            
            const titles = {
                'beranda': 'Beranda',
                'template': 'Template Form Laporan',
                'dataSiswa': 'Data Siswa',
                'daftarLaporan': 'Daftar Laporan',
                'pengaturan': 'Pengaturan'
            };
            
            document.getElementById(menuMap[menu]).classList.remove('hidden');
            document.getElementById('adminPageTitle').textContent = titles[menu];
            
            const activeBtn = document.querySelector(`.admin-menu-btn[data-menu="${menu}"]`);
            if (activeBtn) {
                activeBtn.classList.add('bg-pastel-purple', 'text-purple-700');
            }
            
            // Close sidebar on mobile
            if (window.innerWidth < 1024) {
                toggleSidebar('admin');
            }
            
            updateUI();
        }
        
        function showSiswaMenu(menu) {
            document.querySelectorAll('.siswa-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.siswa-menu-btn').forEach(btn => {
                btn.classList.remove('bg-pastel-mint', 'text-teal-700');
            });
            
            const menuMap = {
                'beranda': 'siswaBeranda',
                'inputLaporan': 'siswaInputLaporan',
                'catatanGuru': 'siswaCatatanGuru'
            };
            
            const titles = {
                'beranda': 'Beranda',
                'inputLaporan': 'Input Laporan',
                'catatanGuru': 'Catatan Guru BK'
            };
            
            document.getElementById(menuMap[menu]).classList.remove('hidden');
            document.getElementById('siswaPageTitle').textContent = titles[menu];
            
            const activeBtn = document.querySelector(`.siswa-menu-btn[data-menu="${menu}"]`);
            if (activeBtn) {
                activeBtn.classList.add('bg-pastel-mint', 'text-teal-700');
            }
            
            // Close sidebar on mobile
            if (window.innerWidth < 1024) {
                toggleSidebar('siswa');
            }
        }
        
        // ==================== UI UPDATE ====================
        function updateUI() {
            updateStats();
            renderSiswaTable();
            renderLaporanTable();
            renderRecentReports();
            renderRecentActivities();
            renderTemplateFields();
            updateTemplatePreview();
            
            if (currentUser && currentUser.role === 'siswa') {
                renderSiswaForm();
                renderCatatanSiswa();
            }
        }
        
        function updateStats() {
            document.getElementById('statSiswa').textContent = appData.siswa.length;
            document.getElementById('statLaporan').textContent = appData.laporan.length;
            document.getElementById('statDitangani').textContent = appData.laporan.filter(l => l.status === 'Ditangani').length;
            
            const belumDitangani = appData.laporan.filter(l => l.status !== 'Ditangani').length;
            const badge = document.getElementById('laporanBadge');
            if (belumDitangani > 0) {
                badge.textContent = belumDitangani;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
        
        function renderSiswaTable() {
            const tbody = document.getElementById('siswaTableBody');
            if (appData.siswa.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Belum ada siswa terdaftar</td></tr>';
                return;
            }
            
            tbody.innerHTML = appData.siswa.map((s, i) => `
                <tr class="border-b hover:bg-pastel-lavender/30 transition siswa-row" data-nama="${s.nama_lengkap?.toLowerCase() || ''}" data-kelas="${s.kelas?.toLowerCase() || ''}">
                    <td class="px-4 py-3">${i + 1}</td>
                    <td class="px-4 py-3 font-medium">${escapeHtml(s.nama_lengkap)}</td>
                    <td class="px-4 py-3">${escapeHtml(s.kelas)}</td>
                    <td class="px-4 py-3">${escapeHtml(s.nomor_absen)}</td>
                    <td class="px-4 py-3">${escapeHtml(s.nomor_wa)}</td>
                    <td class="px-4 py-3">${escapeHtml(s.username)}</td>
                    <td class="px-4 py-3">
                        <button onclick="deleteSiswa('${s.__backendId}')" class="px-3 py-1 bg-red-100 text-red-600 text-sm rounded-lg hover:bg-red-200 transition">Hapus</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function renderLaporanTable() {
            const tbody = document.getElementById('laporanTableBody');
            if (appData.laporan.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Belum ada laporan masuk</td></tr>';
                return;
            }
            
            const sortedLaporan = [...appData.laporan].sort((a, b) => new Date(b.tanggal_laporan) - new Date(a.tanggal_laporan));
            
            tbody.innerHTML = sortedLaporan.map((l, i) => `
                <tr class="border-b hover:bg-pastel-blue/30 transition laporan-row" data-nama="${l.nama_lengkap?.toLowerCase() || ''}" data-status="${l.status || 'Menunggu'}">
                    <td class="px-4 py-3">${i + 1}</td>
                    <td class="px-4 py-3">${formatDate(l.tanggal_laporan)}</td>
                    <td class="px-4 py-3 font-medium">${escapeHtml(l.nama_lengkap)}</td>
                    <td class="px-4 py-3">${escapeHtml(l.kelas)}</td>
                    <td class="px-4 py-3"><span class="px-2 py-1 bg-pastel-purple/50 text-purple-700 text-xs rounded-full">${escapeHtml(l.kategori || '-')}</span></td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 ${l.status === 'Ditangani' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'} text-xs rounded-full">${l.status || 'Menunggu'}</span>
                    </td>
                    <td class="px-4 py-3">
                        <button onclick="viewLaporan('${l.__backendId}')" class="px-3 py-1 bg-pastel-blue text-blue-700 text-sm rounded-lg hover:bg-blue-200 transition">Detail</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function renderRecentReports() {
            const container = document.getElementById('recentReports');
            const recent = [...appData.laporan]
                .sort((a, b) => new Date(b.tanggal_laporan) - new Date(a.tanggal_laporan))
                .slice(0, 5);
            
            if (recent.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">Belum ada laporan</p>';
                return;
            }
            
            container.innerHTML = recent.map(l => `
                <div class="flex items-center gap-3 p-3 bg-pastel-pink/30 rounded-xl">
                    <div class="w-10 h-10 bg-pink-200 rounded-full flex items-center justify-center flex-shrink-0">
                        <span class="text-pink-600 font-bold">${l.nama_lengkap?.charAt(0)?.toUpperCase() || '?'}</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="font-medium text-gray-700 truncate">${escapeHtml(l.nama_lengkap)}</p>
                        <p class="text-xs text-gray-500">${escapeHtml(l.kategori || 'Umum')} ‚Ä¢ ${formatDate(l.tanggal_laporan)}</p>
                    </div>
                    <span class="px-2 py-1 ${l.status === 'Ditangani' ? 'bg-green-100 text-green-600' : 'bg-yellow-100 text-yellow-600'} text-xs rounded-full flex-shrink-0">${l.status || 'Menunggu'}</span>
                </div>
            `).join('');
        }
        
        function renderRecentActivities() {
            const container = document.getElementById('recentActivities');
            const activities = appData.activities.slice(-3).reverse();
            
            if (activities.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">Belum ada aktivitas</p>';
                return;
            }
            
            container.innerHTML = activities.map(a => `
                <div class="flex items-center gap-3 p-3 bg-pastel-mint/30 rounded-xl">
                    <div class="w-10 h-10 bg-green-200 rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm text-gray-700">${escapeHtml(a.text)}</p>
                        <p class="text-xs text-gray-500">${a.time}</p>
                    </div>
                </div>
            `).join('');
        }
        
        function addActivity(text) {
            appData.activities.push({
                text: text,
                time: new Date().toLocaleString('id-ID')
            });
            if (appData.activities.length > 10) {
                appData.activities.shift();
            }
            renderRecentActivities();
        }
        
        // ==================== TEMPLATE MANAGEMENT ====================
        function renderTemplateFields() {
            const container = document.getElementById('templateFields');
            if (!container) return;
            
            container.innerHTML = appData.template.fields.map((field, i) => `
                <div class="flex flex-col md:flex-row gap-3 p-4 bg-pastel-lavender/30 rounded-xl template-field" data-index="${i}">
                    <div class="flex-1 grid grid-cols-1 md:grid-cols-4 gap-3">
                        <input type="text" value="${escapeHtml(field.label)}" onchange="updateFieldLabel(${i}, this.value)" placeholder="Label" class="px-3 py-2 rounded-lg bg-white border border-gray-200 focus:border-purple-400 outline-none">
                        <select onchange="updateFieldType(${i}, this.value)" class="px-3 py-2 rounded-lg bg-white border border-gray-200 focus:border-purple-400 outline-none">
                            <option value="text" ${field.type === 'text' ? 'selected' : ''}>Teks Singkat</option>
                            <option value="textarea" ${field.type === 'textarea' ? 'selected' : ''}>Teks Panjang</option>
                            <option value="select" ${field.type === 'select' ? 'selected' : ''}>Pilihan</option>
                            <option value="date" ${field.type === 'date' ? 'selected' : ''}>Tanggal</option>
                        </select>
                        ${field.type === 'select' ? `
                            <input type="text" value="${(field.options || []).join(', ')}" onchange="updateFieldOptions(${i}, this.value)" placeholder="Opsi (pisah dengan koma)" class="px-3 py-2 rounded-lg bg-white border border-gray-200 focus:border-purple-400 outline-none md:col-span-2">
                        ` : `
                            <input type="text" value="${escapeHtml(field.placeholder || '')}" onchange="updateFieldPlaceholder(${i}, this.value)" placeholder="Placeholder" class="px-3 py-2 rounded-lg bg-white border border-gray-200 focus:border-purple-400 outline-none md:col-span-2">
                        `}
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="flex items-center gap-2 text-sm text-gray-600">
                            <input type="checkbox" ${field.required ? 'checked' : ''} onchange="updateFieldRequired(${i}, this.checked)" class="w-4 h-4 rounded text-purple-500">
                            Wajib
                        </label>
                        <button onclick="removeTemplateField(${i})" class="p-2 text-red-500 hover:bg-red-100 rounded-lg transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                </div>
            `).join('');
            
            updateTemplatePreview();
        }
        
        function addTemplateField() {
            const id = 'field_' + Date.now();
            appData.template.fields.push({
                id: id,
                label: 'Field Baru',
                type: 'text',
                placeholder: '',
                required: false
            });
            renderTemplateFields();
        }
        
        function removeTemplateField(index) {
            appData.template.fields.splice(index, 1);
            renderTemplateFields();
        }
        
        function updateFieldLabel(index, value) {
            appData.template.fields[index].label = value;
            appData.template.fields[index].id = value.toLowerCase().replace(/\s+/g, '_');
            updateTemplatePreview();
        }
        
        function updateFieldType(index, value) {
            appData.template.fields[index].type = value;
            if (value === 'select' && !appData.template.fields[index].options) {
                appData.template.fields[index].options = ['Opsi 1', 'Opsi 2'];
            }
            renderTemplateFields();
        }
        
        function updateFieldPlaceholder(index, value) {
            appData.template.fields[index].placeholder = value;
            updateTemplatePreview();
        }
        
        function updateFieldOptions(index, value) {
            appData.template.fields[index].options = value.split(',').map(o => o.trim());
            updateTemplatePreview();
        }
        
        function updateFieldRequired(index, value) {
            appData.template.fields[index].required = value;
            updateTemplatePreview();
        }
        
        function updateTemplatePreview() {
            const preview = document.getElementById('templatePreview');
            if (!preview) return;
            
            if (appData.template.fields.length === 0) {
                preview.innerHTML = '<p class="text-gray-500 text-sm text-center">Tambahkan field untuk melihat preview</p>';
                return;
            }
            
            preview.innerHTML = appData.template.fields.map(field => {
                let input = '';
                switch (field.type) {
                    case 'textarea':
                        input = `<textarea placeholder="${escapeHtml(field.placeholder || '')}" class="w-full px-4 py-3 rounded-xl bg-white border-2 border-gray-200 outline-none resize-none" rows="3" disabled></textarea>`;
                        break;
                    case 'select':
                        input = `<select class="w-full px-4 py-3 rounded-xl bg-white border-2 border-gray-200 outline-none" disabled>
                            <option>Pilih ${escapeHtml(field.label)}</option>
                            ${(field.options || []).map(o => `<option>${escapeHtml(o)}</option>`).join('')}
                        </select>`;
                        break;
                    case 'date':
                        input = `<input type="date" class="w-full px-4 py-3 rounded-xl bg-white border-2 border-gray-200 outline-none" disabled>`;
                        break;
                    default:
                        input = `<input type="text" placeholder="${escapeHtml(field.placeholder || '')}" class="w-full px-4 py-3 rounded-xl bg-white border-2 border-gray-200 outline-none" disabled>`;
                }
                return `
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-600 mb-2">${escapeHtml(field.label)} ${field.required ? '<span class="text-red-500">*</span>' : ''}</label>
                        ${input}
                    </div>
                `;
            }).join('');
        }
        
        async function saveTemplate() {
            const btn = document.getElementById('saveTemplateBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Menyimpan...';
            
            if (window.dataSdk) {
                // Find existing template
                const existingTemplate = appData.laporan.length === 0 ? null : 
                    (await new Promise(resolve => {
                        const t = appData.siswa.concat(appData.laporan).find(d => d.type === 'template');
                        resolve(t);
                    }));
                
                const templateData = {
                    type: 'template',
                    fields_json: JSON.stringify(appData.template.fields),
                    created_at: new Date().toISOString()
                };
                
                // For simplicity, always create new (in real app would update existing)
                const result = await window.dataSdk.create(templateData);
                
                if (result.isOk) {
                    showToast('Template berhasil disimpan!', 'success');
                    addActivity('Template form laporan diperbarui');
                } else {
                    showToast('Gagal menyimpan template', 'error');
                }
            }
            
            btn.disabled = false;
            btn.textContent = 'Simpan Template';
        }
        
        // ==================== SISWA FORM ====================
        function renderSiswaForm() {
            const container = document.getElementById('siswaFormContainer');
            if (!container) return;
            
            if (appData.template.fields.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Form belum tersedia. Hubungi Guru BK untuk mengaktifkan form laporan.</p>';
                return;
            }
            
            let formHtml = appData.template.fields.map(field => {
                let input = '';
                const fieldId = `siswa_${field.id}`;
                switch (field.type) {
                    case 'textarea':
                        input = `<textarea id="${fieldId}" placeholder="${escapeHtml(field.placeholder || '')}" class="w-full px-4 py-3 rounded-xl bg-pastel-mint/30 border-2 border-transparent focus:border-teal-400 focus:bg-white outline-none resize-none transition" rows="4" ${field.required ? 'required' : ''}></textarea>`;
                        break;
                    case 'select':
                        input = `<select id="${fieldId}" class="w-full px-4 py-3 rounded-xl bg-pastel-mint/30 border-2 border-transparent focus:border-teal-400 focus:bg-white outline-none transition" ${field.required ? 'required' : ''}>
                            <option value="">Pilih ${escapeHtml(field.label)}</option>
                            ${(field.options || []).map(o => `<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join('')}
                        </select>`;
                        break;
                    case 'date':
                        input = `<input type="date" id="${fieldId}" class="w-full px-4 py-3 rounded-xl bg-pastel-mint/30 border-2 border-transparent focus:border-teal-400 focus:bg-white outline-none transition" ${field.required ? 'required' : ''}>`;
                        break;
                    default:
                        input = `<input type="text" id="${fieldId}" placeholder="${escapeHtml(field.placeholder || '')}" class="w-full px-4 py-3 rounded-xl bg-pastel-mint/30 border-2 border-transparent focus:border-teal-400 focus:bg-white outline-none transition" ${field.required ? 'required' : ''}>`;
                }
                return `
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">${escapeHtml(field.label)} ${field.required ? '<span class="text-red-500">*</span>' : ''}</label>
                        ${input}
                    </div>
                `;
            }).join('');
            
            formHtml += `
                <div id="submitError" class="hidden text-red-500 text-sm text-center bg-red-50 p-3 rounded-xl"></div>
                <button onclick="submitLaporan()" id="submitLaporanBtn" class="w-full py-3 bg-gradient-to-r from-teal-500 to-cyan-500 text-white font-semibold rounded-xl hover:opacity-90 transition shadow-lg mt-4">
                    Kirim Laporan
                </button>
            `;
            
            container.innerHTML = formHtml;
        }
        
        async function submitLaporan() {
            if (!currentUser || currentUser.role !== 'siswa') return;
            
            const btn = document.getElementById('submitLaporanBtn');
            const errorEl = document.getElementById('submitError');
            
            // Collect form data
            const formData = {
                type: 'laporan',
                nama_lengkap: currentUser.nama_lengkap,
                kelas: currentUser.kelas,
                nomor_absen: currentUser.nomor_absen,
                tanggal_laporan: new Date().toISOString(),
                status: 'Menunggu',
                catatan_guru: '',
                created_at: new Date().toISOString()
            };
            
            // Validate and collect field values
            for (const field of appData.template.fields) {
                const input = document.getElementById(`siswa_${field.id}`);
                if (!input) continue;
                
                const value = input.value.trim();
                if (field.required && !value) {
                    errorEl.textContent = `${field.label} harus diisi!`;
                    errorEl.classList.remove('hidden');
                    return;
                }
                formData[field.id] = value;
            }
            
            if (appData.laporan.length >= 999) {
                errorEl.textContent = 'Batas maksimum laporan tercapai!';
                errorEl.classList.remove('hidden');
                return;
            }
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Mengirim...';
            errorEl.classList.add('hidden');
            
            if (window.dataSdk) {
                const result = await window.dataSdk.create(formData);
                
                if (result.isOk) {
                    showToast('Laporan berhasil dikirim! Guru BK akan segera merespons.', 'success');
                    // Clear form
                    appData.template.fields.forEach(field => {
                        const input = document.getElementById(`siswa_${field.id}`);
                        if (input) input.value = '';
                    });
                } else {
                    errorEl.textContent = 'Gagal mengirim laporan. Coba lagi.';
                    errorEl.classList.remove('hidden');
                }
            }
            
            btn.disabled = false;
            btn.textContent = 'Kirim Laporan';
        }
        
        function renderCatatanSiswa() {
            if (!currentUser || currentUser.role !== 'siswa') return;
            
            const container = document.getElementById('catatanContainer');
            const myReports = appData.laporan.filter(l => l.nama_lengkap === currentUser.nama_lengkap);
            
            if (myReports.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada catatan dari Guru BK</p>';
                return;
            }
            
            const sortedReports = [...myReports].sort((a, b) => new Date(b.tanggal_laporan) - new Date(a.tanggal_laporan));
            
            container.innerHTML = sortedReports.map(l => `
                <div class="bg-pastel-mint/30 rounded-xl p-4">
                    <div class="flex items-start justify-between mb-3">
                        <div>
                            <span class="px-2 py-1 bg-pastel-purple text-purple-700 text-xs rounded-full">${escapeHtml(l.kategori || 'Umum')}</span>
                            <span class="ml-2 px-2 py-1 ${l.status === 'Ditangani' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'} text-xs rounded-full">${l.status || 'Menunggu'}</span>
                        </div>
                        <span class="text-xs text-gray-500">${formatDate(l.tanggal_laporan)}</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-3">${escapeHtml(l.isi_laporan || '-').substring(0, 100)}${(l.isi_laporan || '').length > 100 ? '...' : ''}</p>
                    ${l.catatan_guru ? `
                        <div class="bg-white/70 rounded-lg p-3 mt-2">
                            <p class="text-xs font-medium text-gray-500 mb-1">Catatan Guru BK:</p>
                            <p class="text-sm text-gray-700">${escapeHtml(l.catatan_guru)}</p>
                        </div>
                    ` : '<p class="text-xs text-gray-400 italic">Belum ada catatan dari Guru BK</p>'}
                </div>
            `).join('');
            
            // Update badge
            const withCatatan = myReports.filter(l => l.catatan_guru).length;
            const badge = document.getElementById('catatanBadge');
            if (withCatatan > 0) {
                badge.textContent = withCatatan;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
        
        // ==================== LAPORAN MANAGEMENT ====================
        function viewLaporan(id) {
            currentLaporan = appData.laporan.find(l => l.__backendId === id);
            if (!currentLaporan) return;
            
            const modal = document.getElementById('modalDetail');
            const content = document.getElementById('modalContent');
            
            let detailHtml = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-xs text-gray-500">Nama Siswa</p>
                            <p class="font-medium text-gray-700">${escapeHtml(currentLaporan.nama_lengkap)}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">Kelas</p>
                            <p class="font-medium text-gray-700">${escapeHtml(currentLaporan.kelas)}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">Tanggal Laporan</p>
                            <p class="font-medium text-gray-700">${formatDate(currentLaporan.tanggal_laporan)}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">Status</p>
                            <span class="px-2 py-1 ${currentLaporan.status === 'Ditangani' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'} text-xs rounded-full">${currentLaporan.status || 'Menunggu'}</span>
                        </div>
                    </div>
            `;
            
            // Show all template fields
            appData.template.fields.forEach(field => {
                const value = currentLaporan[field.id] || '-';
                detailHtml += `
                    <div>
                        <p class="text-xs text-gray-500">${escapeHtml(field.label)}</p>
                        <p class="text-gray-700 whitespace-pre-wrap">${escapeHtml(value)}</p>
                    </div>
                `;
            });
            
            if (currentLaporan.catatan_guru) {
                detailHtml += `
                    <div class="bg-pastel-yellow/50 rounded-xl p-4">
                        <p class="text-xs text-gray-500 mb-1">Catatan Guru BK</p>
                        <p class="text-gray-700">${escapeHtml(currentLaporan.catatan_guru)}</p>
                    </div>
                `;
            }
            
            detailHtml += `
                <div id="catatanFormContainer" class="hidden">
                    <label class="block text-sm font-medium text-gray-600 mb-2">Catatan untuk Siswa</label>
                    <textarea id="inputCatatan" class="w-full px-4 py-3 rounded-xl bg-pastel-yellow/30 border-2 border-transparent focus:border-yellow-400 focus:bg-white outline-none resize-none transition" rows="3" placeholder="Tulis catatan untuk siswa...">${escapeHtml(currentLaporan.catatan_guru || '')}</textarea>
                    <button onclick="saveCatatan()" id="saveCatatanBtn" class="mt-2 px-4 py-2 bg-yellow-500 text-white font-medium rounded-xl hover:bg-yellow-600 transition">Simpan Catatan</button>
                </div>
            </div>`;
            
            content.innerHTML = detailHtml;
            
            // Update handled button
            const btnHandled = document.getElementById('btnHandled');
            if (currentLaporan.status === 'Ditangani') {
                btnHandled.classList.add('opacity-50');
                btnHandled.disabled = true;
            } else {
                btnHandled.classList.remove('opacity-50');
                btnHandled.disabled = false;
            }
            
            modal.classList.remove('hidden');
        }
        
        function closeModal() {
            document.getElementById('modalDetail').classList.add('hidden');
            currentLaporan = null;
        }
        
        function showCatatanForm() {
            const container = document.getElementById('catatanFormContainer');
            container.classList.toggle('hidden');
        }
        
        async function saveCatatan() {
            if (!currentLaporan || !window.dataSdk) return;
            
            const catatan = document.getElementById('inputCatatan').value.trim();
            const btn = document.getElementById('saveCatatanBtn');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Menyimpan...';
            
            const updatedLaporan = { ...currentLaporan, catatan_guru: catatan };
            const result = await window.dataSdk.update(updatedLaporan);
            
            if (result.isOk) {
                showToast('Catatan berhasil disimpan!', 'success');
                addActivity(`Catatan ditambahkan untuk laporan ${currentLaporan.nama_lengkap}`);
                closeModal();
            } else {
                showToast('Gagal menyimpan catatan', 'error');
            }
            
            btn.disabled = false;
            btn.textContent = 'Simpan Catatan';
        }
        
        async function markAsHandled() {
            if (!currentLaporan || !window.dataSdk) return;
            
            const btn = document.getElementById('btnHandled');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>';
            
            const updatedLaporan = { ...currentLaporan, status: 'Ditangani' };
            const result = await window.dataSdk.update(updatedLaporan);
            
            if (result.isOk) {
                showToast('Laporan ditandai sudah ditangani!', 'success');
                addActivity(`Laporan ${currentLaporan.nama_lengkap} ditandai ditangani`);
                closeModal();
            } else {
                showToast('Gagal mengubah status', 'error');
            }
            
            btn.disabled = false;
            btn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Tandai Ditangani';
        }
        
        function printLaporan() {
            if (!currentLaporan) return;
            
            const printContent = `
                <div style="font-family: 'Nunito', sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                    <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #A78BFA; padding-bottom: 20px;">
                        <h1 style="font-size: 24px; color: #374151; margin: 0;">KARTU LAPORAN KASUS</h1>
                        <p style="color: #6B7280; margin: 5px 0;">${escapeHtml(appData.settings.nama_instansi || 'Nama Sekolah')}</p>
                        <p style="font-size: 12px; color: #9CA3AF;">Layanan Bimbingan & Konseling</p>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <tr>
                            <td style="padding: 8px; border: 1px solid #E5E7EB; background: #F9FAFB; width: 30%;"><strong>Nama Siswa</strong></td>
                            <td style="padding: 8px; border: 1px solid #E5E7EB;">${escapeHtml(currentLaporan.nama_lengkap)}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #E5E7EB; background: #F9FAFB;"><strong>Kelas</strong></td>
                            <td style="padding: 8px; border: 1px solid #E5E7EB;">${escapeHtml(currentLaporan.kelas)}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #E5E7EB; background: #F9FAFB;"><strong>Tanggal Laporan</strong></td>
                            <td style="padding: 8px; border: 1px solid #E5E7EB;">${formatDate(currentLaporan.tanggal_laporan)}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #E5E7EB; background: #F9FAFB;"><strong>Kategori</strong></td>
                            <td style="padding: 8px; border: 1px solid #E5E7EB;">${escapeHtml(currentLaporan.kategori || '-')}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #E5E7EB; background: #F9FAFB;"><strong>Status</strong></td>
                            <td style="padding: 8px; border: 1px solid #E5E7EB;">${currentLaporan.status || 'Menunggu'}</td>
                        </tr>
                    </table>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="font-size: 14px; color: #374151; margin-bottom: 10px;">Isi Laporan:</h3>
                        <div style="background: #F9FAFB; padding: 15px; border-radius: 8px; border: 1px solid #E5E7EB;">
                            <p style="margin: 0; white-space: pre-wrap; color: #4B5563;">${escapeHtml(currentLaporan.isi_laporan || '-')}</p>
                        </div>
                    </div>
                    
                    ${currentLaporan.catatan_guru ? `
                        <div style="margin-bottom: 20px;">
                            <h3 style="font-size: 14px; color: #374151; margin-bottom: 10px;">Catatan Guru BK:</h3>
                            <div style="background: #FEF3C7; padding: 15px; border-radius: 8px; border: 1px solid #FDE68A;">
                                <p style="margin: 0; color: #92400E;">${escapeHtml(currentLaporan.catatan_guru)}</p>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 40px; display: flex; justify-content: space-between;">
                        <div style="text-align: center;">
                            <p style="margin: 0; font-size: 12px; color: #6B7280;">Dicetak pada:</p>
                            <p style="margin: 5px 0; font-size: 12px;">${new Date().toLocaleString('id-ID')}</p>
                        </div>
                        <div style="text-align: center;">
                            <p style="margin: 0; font-size: 12px; color: #6B7280;">Guru BK</p>
                            <div style="height: 60px;"></div>
                            <p style="margin: 0; font-size: 12px; border-top: 1px solid #374151; padding-top: 5px;">${escapeHtml(appData.settings.nama_guru || '..................')}</p>
                            <p style="margin: 0; font-size: 10px; color: #6B7280;">NIP. ${escapeHtml(appData.settings.nip_guru || '..................')}</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Use html2pdf library
            const element = document.createElement('div');
            element.innerHTML = printContent;
            document.body.appendChild(element);
            
            const opt = {
                margin: 10,
                filename: `Laporan_${currentLaporan.nama_lengkap}_${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save().then(() => {
                document.body.removeChild(element);
                showToast('PDF berhasil diunduh!', 'success');
            }).catch(err => {
                document.body.removeChild(element);
                console.error('PDF generation error:', err);
                // Fallback to browser print
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Cetak Laporan</title>
                        <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
                    </head>
                    <body>${printContent}</body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
            });
        }
        
        async function deleteSiswa(id) {
            const siswa = appData.siswa.find(s => s.__backendId === id);
            if (!siswa || !window.dataSdk) return;
            
            // Simple inline confirmation
            const row = document.querySelector(`tr[data-nama="${siswa.nama_lengkap?.toLowerCase()}"]`);
            if (row) {
                const actionCell = row.querySelector('td:last-child');
                const originalContent = actionCell.innerHTML;
                
                actionCell.innerHTML = `
                    <div class="flex gap-2">
                        <button onclick="confirmDeleteSiswa('${id}')" class="px-2 py-1 bg-red-500 text-white text-xs rounded-lg">Ya, Hapus</button>
                        <button onclick="cancelDelete(this, '${escapeHtml(originalContent).replace(/'/g, "\\'")}')" class="px-2 py-1 bg-gray-200 text-gray-600 text-xs rounded-lg">Batal</button>
                    </div>
                `;
            }
        }
        
        async function confirmDeleteSiswa(id) {
            const siswa = appData.siswa.find(s => s.__backendId === id);
            if (!siswa || !window.dataSdk) return;
            
            const result = await window.dataSdk.delete(siswa);
            if (result.isOk) {
                showToast('Siswa berhasil dihapus', 'success');
                addActivity(`Data siswa ${siswa.nama_lengkap} dihapus`);
            } else {
                showToast('Gagal menghapus siswa', 'error');
            }
        }
        
        function cancelDelete(btn, originalContent) {
            const cell = btn.closest('td');
            cell.innerHTML = originalContent;
        }
        
        // ==================== SETTINGS ====================
        async function saveSettings() {
            const btn = document.getElementById('saveSettingsBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Menyimpan...';
            
            const settings = {
                type: 'settings',
                nama_instansi: document.getElementById('setNamaInstansi').value.trim(),
                nama_guru: document.getElementById('setNamaGuru').value.trim(),
                nip_guru: document.getElementById('setNipGuru').value.trim(),
                created_at: new Date().toISOString()
            };
            
            if (window.dataSdk) {
                const result = await window.dataSdk.create(settings);
                if (result.isOk) {
                    showToast('Pengaturan berhasil disimpan!', 'success');
                    addActivity('Pengaturan instansi diperbarui');
                    appData.settings = settings;
                    document.getElementById('adminNamaDisplay').textContent = settings.nama_guru || 'Administrator';
                    updateInstansiDisplay();
                } else {
                    showToast('Gagal menyimpan pengaturan', 'error');
                }
            }
            
            btn.disabled = false;
            btn.textContent = 'Simpan Pengaturan';
        }
        
        function copyAppsScript() {
            const code = document.querySelector('#adminPengaturan pre code').textContent;
            navigator.clipboard.writeText(code).then(() => {
                showToast('Kode Apps Script berhasil disalin!', 'success');
            }).catch(() => {
                showToast('Gagal menyalin kode', 'error');
            });
        }
        
        // ==================== FILTERS ====================
        function filterSiswa() {
            const search = document.getElementById('searchSiswa').value.toLowerCase();
            document.querySelectorAll('.siswa-row').forEach(row => {
                const nama = row.dataset.nama || '';
                const kelas = row.dataset.kelas || '';
                if (nama.includes(search) || kelas.includes(search)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        function filterLaporan() {
            const search = document.getElementById('searchLaporan').value.toLowerCase();
            const status = document.getElementById('filterStatus').value;
            
            document.querySelectorAll('.laporan-row').forEach(row => {
                const nama = row.dataset.nama || '';
                const rowStatus = row.dataset.status || '';
                const matchSearch = nama.includes(search);
                const matchStatus = !status || rowStatus === status;
                
                if (matchSearch && matchStatus) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // ==================== UTILITY FUNCTIONS ====================
        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        
        function updateInstansiDisplay() {
            const instansiName = appData.settings.nama_instansi || '-';
            const loginInstansi = document.getElementById('loginInstansi');
            if (loginInstansi) {
                loginInstansi.textContent = escapeHtml(instansiName);
            }
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            try {
                return new Date(dateStr).toLocaleDateString('id-ID', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch {
                return dateStr;
            }
        }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };
            
            toast.className = `toast px-4 py-3 ${colors[type]} text-white rounded-xl shadow-lg flex items-center gap-2 max-w-sm`;
            toast.innerHTML = `
                <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    ${type === 'success' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>' : 
                      type === 'error' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>' :
                      '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>'}
                </svg>
                <span>${escapeHtml(message)}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9d25aeb7c21a2dee',t:'MTc3MTgzODc5Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>